<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}} - shebang.run</title>
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js" defer></script>
    <script src="/static/libsodium.js"></script>
    <script src="/static/libsodium-wrappers.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/shell/shell.min.js"></script>
    <script src="/static/crypto.js"></script>
</head>
<body class="bg-gray-50" x-data="{ showCookieNotice: !localStorage.getItem('cookieConsent') }">
    <nav class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <a href="/" class="flex items-center space-x-2">
                            <img src="/static/logo.png" alt="shebang.run" class="h-12">
                            <span class="text-2xl font-bold text-indigo-600">.run</span>
                        </a>
                    </div>
                </div>
                <div class="flex items-center space-x-4" x-data="{ loggedIn: !!localStorage.getItem('token') && !isTokenExpired(localStorage.getItem('token')), isAdmin: JSON.parse(localStorage.getItem('user') || '{}').is_admin, mobileMenuOpen: false }">
                    <!-- Mobile menu button (logged in) -->
                    <button x-show="loggedIn" @click="mobileMenuOpen = !mobileMenuOpen" class="md:hidden text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path x-show="!mobileMenuOpen" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                            <path x-show="mobileMenuOpen" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                    
                    <!-- Desktop menu (logged in) -->
                    <div x-show="loggedIn" class="hidden md:flex items-center space-x-4">
                        <a href="/dashboard" class="text-gray-700 hover:text-gray-900">Scripts</a>
                        <a href="/community" class="text-gray-700 hover:text-gray-900">Community</a>
                        <a href="/keys" class="text-gray-700 hover:text-gray-900">Keys</a>
                        <a href="/secrets" class="text-gray-700 hover:text-gray-900">Secrets</a>
                        <a href="/account" class="text-gray-700 hover:text-gray-900">Account</a>
                        <a x-show="isAdmin" href="/admin" class="text-purple-700 hover:text-purple-900 font-medium">Admin</a>
                        <button @click="localStorage.removeItem('token'); localStorage.removeItem('user'); window.location.href='/'" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Logout</button>
                    </div>
                    
                    <!-- Mobile menu (logged in) -->
                    <div x-show="loggedIn && mobileMenuOpen" @click.away="mobileMenuOpen = false" 
                         class="md:hidden absolute top-16 right-0 bg-white shadow-lg rounded-lg p-4 space-y-2 z-50">
                        <a href="/dashboard" class="block text-gray-700 hover:text-gray-900 py-2">Scripts</a>
                        <a href="/community" class="block text-gray-700 hover:text-gray-900 py-2">Community</a>
                        <a href="/keys" class="block text-gray-700 hover:text-gray-900 py-2">Keys</a>
                        <a href="/secrets" class="block text-gray-700 hover:text-gray-900 py-2">Secrets</a>
                        <a href="/account" class="block text-gray-700 hover:text-gray-900 py-2">Account</a>
                        <a x-show="isAdmin" href="/admin" class="block text-purple-700 hover:text-purple-900 font-medium py-2">Admin</a>
                        <button @click="localStorage.removeItem('token'); localStorage.removeItem('user'); window.location.href='/'" 
                                class="w-full bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Logout</button>
                    </div>
                    
                    <!-- Not logged in -->
                    <div x-show="!loggedIn" class="flex items-center space-x-4">
                        <a href="/login" class="text-gray-700 hover:text-gray-900">Login</a>
                        <a href="/register" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Sign Up</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {{template "content" .}}
    </main>

    <!-- Cookie Notice -->
    <div x-show="showCookieNotice" x-cloak class="fixed bottom-0 left-0 right-0 bg-gray-900 text-white p-4 shadow-lg z-50">
        <div class="max-w-7xl mx-auto flex items-center justify-between flex-wrap gap-4">
            <div class="flex-1">
                <p class="text-sm">
                    We use essential cookies to store your authentication token locally in your browser. 
                    No tracking or analytics cookies are used. By continuing, you accept our 
                    <a href="/privacy" class="underline">Privacy Policy</a> and 
                    <a href="/terms" class="underline">Terms of Service</a>.
                </p>
            </div>
            <button @click="localStorage.setItem('cookieConsent', 'true'); showCookieNotice = false" 
                    class="bg-indigo-600 px-6 py-2 rounded hover:bg-indigo-700 whitespace-nowrap">
                Accept
            </button>
        </div>
    </div>

    <footer class="bg-white border-t mt-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div>
                    <h3 class="font-bold mb-2">shebang.run</h3>
                    <p class="text-sm text-gray-600">Secure script hosting with versioning</p>
                </div>
                <div>
                    <h3 class="font-bold mb-2">Legal</h3>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li><a href="/privacy" class="hover:text-gray-900">Privacy Policy</a></li>
                        <li><a href="/terms" class="hover:text-gray-900">Terms of Service</a></li>
                        <li><a href="/gdpr" class="hover:text-gray-900">GDPR Information</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-bold mb-2">Resources</h3>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li><a href="/docs" class="hover:text-gray-900">Documentation</a></li>
                        <li><a href="/api-reference" class="hover:text-gray-900">API Reference</a></li>
                        <li><a href="https://github.com/skibare87/shebangrun" class="hover:text-gray-900">GitHub</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>

    <script>
        function isTokenExpired(token) {
            if (!token) return true;
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                return payload.exp * 1000 < Date.now();
            } catch (e) {
                return true;
            }
        }

        function getToken() {
            const token = localStorage.getItem('token');
            if (isTokenExpired(token)) {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                return null;
            }
            return token;
        }

        // Check token on page load
        const token = localStorage.getItem('token');
        if (token && isTokenExpired(token)) {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            // Only reload if we're on a protected page
            if (window.location.pathname !== '/login' && window.location.pathname !== '/register' && window.location.pathname !== '/') {
                window.location.href = '/login';
            }
        }

        document.body.addEventListener('htmx:configRequest', (event) => {
            const token = getToken();
            if (token) {
                event.detail.headers['Authorization'] = 'Bearer ' + token;
            }
        });
    </script>
</body>
</html>
