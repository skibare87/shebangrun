{{define "content"}}
<div class="max-w-6xl mx-auto" x-data="secretsManager()">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold">Secrets</h1>
        <button @click="showAddModal = true" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
            Add Secret
        </button>
    </div>

    <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg mb-6">
        <p class="text-sm">
            Store encrypted key-value secrets that can be referenced in your scripts using <code class="bg-white px-2 py-1 rounded">${SECRET:KEY_NAME}</code>
        </p>
    </div>

    <!-- Secrets List -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Key Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Last Accessed</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Expires</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                <template x-if="!secrets || secrets.length === 0">
                    <tr>
                        <td colspan="4" class="px-6 py-4 text-center text-gray-500">
                            No secrets yet. Click "Add Secret" to create one.
                        </td>
                    </tr>
                </template>
                <template x-for="secret in secrets" :key="secret.id">
                    <tr>
                        <td class="px-6 py-4">
                            <code class="text-sm font-mono" x-text="secret.key_name"></code>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500" x-text="formatDate(secret.last_accessed)"></td>
                        <td class="px-6 py-4 text-sm text-gray-500" x-text="formatDate(secret.expires_at)"></td>
                        <td class="px-6 py-4 text-sm space-x-2">
                            <button @click="viewSecret(secret.key_name)" class="text-indigo-600 hover:text-indigo-900">View</button>
                            <button @click="editSecret(secret)" class="text-blue-600 hover:text-blue-900">Edit</button>
                            <button @click="copySecret(secret.key_name)" class="text-gray-600 hover:text-gray-900">Copy</button>
                            <button @click="viewAudit(secret.key_name)" class="text-gray-600 hover:text-gray-900">Audit</button>
                            <button @click="deleteSecret(secret.key_name)" class="text-red-600 hover:text-red-900">Delete</button>
                        </td>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>

    <!-- Add/Edit Secret Modal -->
    <div x-show="showAddModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h2 class="text-xl font-bold mb-4" x-text="editingSecret ? 'Edit Secret' : 'Add Secret'"></h2>
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Key Name</label>
                <input type="text" x-model="newSecret.key_name" 
                    :disabled="editingSecret"
                    class="w-full border rounded px-3 py-2"
                    :class="editingSecret ? 'bg-gray-100' : ''"
                    placeholder="AWS_ACCESS_KEY">
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Value</label>
                <textarea x-model="newSecret.value" 
                    class="w-full border rounded px-3 py-2 font-mono text-sm"
                    rows="4"
                    placeholder="Enter secret value"></textarea>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Expires At (optional)</label>
                <input type="datetime-local" x-model="newSecret.expires_at" 
                    class="w-full border rounded px-3 py-2">
            </div>

            <div class="flex justify-end space-x-2">
                <button @click="closeModal()" class="px-4 py-2 border rounded hover:bg-gray-50">Cancel</button>
                <button @click="saveSecret()" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Save</button>
            </div>
        </div>
    </div>

    <!-- View Secret Modal -->
    <div x-show="showViewModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h2 class="text-xl font-bold mb-4">View Secret: <span x-text="viewKeyName"></span></h2>
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Value</label>
                <textarea x-model="viewValue" 
                    readonly
                    class="w-full border rounded px-3 py-2 font-mono text-sm bg-gray-50"
                    rows="6"></textarea>
            </div>

            <div class="flex justify-end space-x-2">
                <button @click="copyFromView()" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">Copy</button>
                <button @click="showViewModal = false" class="px-4 py-2 border rounded hover:bg-gray-50">Close</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div x-show="showToast" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform translate-y-2"
         x-transition:enter-end="opacity-100 transform translate-y-0"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed bottom-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50">
        <span x-text="toastMessage"></span>
    </div>

    <!-- Audit Log Modal -->
    <div x-show="showAuditModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl">
            <h2 class="text-xl font-bold mb-4">Audit Log: <span x-text="auditKeyName"></span></h2>
            
            <div class="max-h-96 overflow-y-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Action</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">IP Address</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Time</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="log in auditLogs" :key="log.accessed_at">
                            <tr>
                                <td class="px-4 py-2 text-sm" x-text="log.action"></td>
                                <td class="px-4 py-2 text-sm font-mono" x-text="log.ip_address"></td>
                                <td class="px-4 py-2 text-sm" x-text="formatDate(log.accessed_at)"></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <div class="flex justify-end mt-4">
                <button @click="showAuditModal = false" class="px-4 py-2 border rounded hover:bg-gray-50">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
function secretsManager() {
    return {
        secrets: [],
        showAddModal: false,
        showViewModal: false,
        showAuditModal: false,
        showToast: false,
        toastMessage: '',
        editingSecret: false,
        viewKeyName: '',
        viewValue: '',
        auditKeyName: '',
        auditLogs: [],
        newSecret: {
            key_name: '',
            value: '',
            expires_at: null
        },

        init() {
            this.loadSecrets();
        },

        showToastMessage(message) {
            this.toastMessage = message;
            this.showToast = true;
            setTimeout(() => { this.showToast = false; }, 3000);
        },

        closeModal() {
            this.showAddModal = false;
            this.editingSecret = false;
            this.newSecret = { key_name: '', value: '', expires_at: null };
        },

        async loadSecrets() {
            const response = await fetch('/api/secrets', {
                headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
            });
            if (response.ok) {
                this.secrets = await response.json() || [];
            } else {
                this.secrets = [];
            }
        },

        async saveSecret() {
            const payload = {
                key_name: this.newSecret.key_name,
                value: this.newSecret.value,
                expires_at: this.newSecret.expires_at || null
            };

            const response = await fetch('/api/secrets', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                this.closeModal();
                this.loadSecrets();
                this.showToastMessage(this.editingSecret ? 'Secret updated' : 'Secret created');
            } else {
                const error = await response.text();
                this.showToastMessage('Error: ' + error);
            }
        },

        async viewSecret(keyName) {
            const response = await fetch(`/api/secrets/${keyName}/value`, {
                headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
            });
            
            if (response.ok) {
                const data = await response.json();
                this.viewKeyName = keyName;
                this.viewValue = data.value;
                this.showViewModal = true;
            } else {
                this.showToastMessage('Failed to retrieve secret');
            }
        },

        async editSecret(secret) {
            const response = await fetch(`/api/secrets/${secret.key_name}/value`, {
                headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
            });
            
            if (response.ok) {
                const data = await response.json();
                this.newSecret = {
                    key_name: secret.key_name,
                    value: data.value,
                    expires_at: secret.expires_at ? secret.expires_at.slice(0, 16) : null
                };
                this.editingSecret = true;
                this.showAddModal = true;
            } else {
                this.showToastMessage('Failed to load secret');
            }
        },

        async copySecret(keyName) {
            const response = await fetch(`/api/secrets/${keyName}/value`, {
                headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
            });
            
            if (response.ok) {
                const data = await response.json();
                navigator.clipboard.writeText(data.value);
                this.showToastMessage('Copied to clipboard');
            } else {
                this.showToastMessage('Failed to retrieve secret');
            }
        },

        copyFromView() {
            navigator.clipboard.writeText(this.viewValue);
            this.showToastMessage('Copied to clipboard');
        },

        async viewAudit(keyName) {
            this.auditKeyName = keyName;
            const response = await fetch(`/api/secrets/${keyName}/audit`, {
                headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
            });
            
            if (response.ok) {
                this.auditLogs = await response.json();
                this.showAuditModal = true;
            }
        },

        async deleteSecret(keyName) {
            if (!confirm(`Delete secret "${keyName}"?`)) return;

            const response = await fetch(`/api/secrets/${keyName}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
            });

            if (response.ok) {
                this.loadSecrets();
                this.showToastMessage('Secret deleted');
            } else {
                this.showToastMessage('Failed to delete secret');
            }
        },

        formatDate(date) {
            if (!date) return 'Never';
            return new Date(date).toLocaleString();
        }
    }
}
</script>
{{end}}
