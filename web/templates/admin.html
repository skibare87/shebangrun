{{define "content"}}
<div x-data="adminPanel()" x-init="init()">
    <h1 class="text-3xl font-bold mb-6">User Administration</h1>

    <div class="bg-white p-6 rounded-lg shadow mb-6">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h2 class="text-xl font-bold">Registered Users</h2>
                <p class="text-sm text-gray-600" x-text="`Total: ${users.length} users`"></p>
            </div>
            <input type="text" x-model="searchQuery" placeholder="Search users..." 
                   class="px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500">
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Username</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Rate Limit</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Created</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-for="user in filteredUsers" :key="user.id">
                        <tr>
                            <td class="px-4 py-3 text-sm font-medium" x-text="user.username"></td>
                            <td class="px-4 py-3 text-sm text-gray-600" x-text="user.email"></td>
                            <td class="px-4 py-3 text-sm">
                                <span x-show="user.is_admin" class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs">Admin</span>
                                <span x-show="!user.is_admin" class="bg-gray-100 text-gray-800 px-2 py-1 rounded text-xs">User</span>
                            </td>
                            <td class="px-4 py-3 text-sm" x-text="user.rate_limit + ' req/min'"></td>
                            <td class="px-4 py-3 text-sm text-gray-600" x-text="new Date(user.created_at).toLocaleDateString()"></td>
                            <td class="px-4 py-3 text-sm space-x-2">
                                <button @click="viewUser(user)" class="text-indigo-600 hover:text-indigo-700">View</button>
                                <button @click="resetPassword(user)" class="text-yellow-600 hover:text-yellow-700">Reset PW</button>
                                <button @click="deleteUser(user)" class="text-red-600 hover:text-red-700">Delete</button>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Toast notification -->
    <div x-show="showToast" x-transition 
         class="fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50"
         style="display: none;">
        <span x-text="toastMessage"></span>
    </div>

    <!-- User Details Modal -->
    <div x-show="showUserModal" @click.away="showUserModal = false"
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white p-8 rounded-lg max-w-2xl w-full" @click.stop>
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-2xl font-bold" x-text="currentUser?.username"></h2>
                <button @click="showUserModal = false" class="text-gray-500 hover:text-gray-700">✕</button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="text-sm font-medium text-gray-700">Email</label>
                    <p class="text-lg" x-text="currentUser?.email"></p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-700">User ID</label>
                    <p class="text-lg" x-text="currentUser?.id"></p>
                </div>
                <div x-show="currentUser">
                    <label class="text-sm font-medium text-gray-700">Account Type</label>
                    <select x-model="currentUser.is_admin" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500">
                        <option :value="false">User</option>
                        <option :value="true">Admin</option>
                    </select>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-700">Rate Limit</label>
                    <input type="number" x-model="currentUser.rate_limit" 
                           class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500">
                    <p class="text-xs text-gray-500 mt-1">Requests per minute</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-700">Max Scripts</label>
                    <input type="number" x-model="userLimits.max_scripts" 
                           class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-700">Max Script Size (bytes)</label>
                    <input type="number" x-model="userLimits.max_script_size" 
                           class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-700">Member Since</label>
                    <p class="text-lg" x-text="new Date(currentUser?.created_at).toLocaleString()"></p>
                </div>
            </div>
            
            <div class="mt-6 flex space-x-4">
                <button @click="saveUserLimits" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
                    Save Settings
                </button>
                <button @click="showUserModal = false" class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Reset Password Modal -->
    <div x-show="showResetModal" @click.away="showResetModal = false"
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white p-8 rounded-lg max-w-md w-full" @click.stop>
            <h2 class="text-2xl font-bold mb-4">Reset Password</h2>
            <p class="text-gray-700 mb-4">
                Reset password for <strong x-text="resetUser?.username"></strong>?
            </p>
            <div x-show="newPassword" class="bg-yellow-50 border border-yellow-200 p-4 rounded mb-4">
                <p class="text-sm font-medium mb-2">New Password:</p>
                <p class="font-mono text-lg" x-text="newPassword"></p>
                <p class="text-xs text-gray-600 mt-2">⚠️ Save this password - it won't be shown again!</p>
            </div>
            <div class="flex space-x-4">
                <button @click="confirmResetPassword" 
                        x-show="!newPassword"
                        class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700">
                    Generate New Password
                </button>
                <button @click="showResetModal = false" class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function adminPanel() {
    return {
        users: [],
        searchQuery: '',
        showToast: false,
        toastMessage: '',
        showUserModal: false,
        showResetModal: false,
        currentUser: null,
        resetUser: null,
        newPassword: '',
        userLimits: {
            max_scripts: null,
            max_script_size: null
        },
        
        init() {
            if (!getToken()) {
                window.location.href = '/login';
                return;
            }
            this.loadUsers();
        },
        
        get filteredUsers() {
            if (!this.searchQuery) return this.users;
            const query = this.searchQuery.toLowerCase();
            return this.users.filter(u => 
                u.username.toLowerCase().includes(query) || 
                u.email.toLowerCase().includes(query)
            );
        },
        
        loadUsers() {
            fetch('/api/admin/users', {
                headers: { 'Authorization': 'Bearer ' + getToken() }
            })
            .then(res => res.json())
            .then(data => this.users = data || [])
            .catch(() => {
                this.showToastMessage('Failed to load users');
            });
        },
        
        viewUser(user) {
            this.currentUser = {...user};
            this.userLimits = {
                max_scripts: null,
                max_script_size: null
            };
            this.showUserModal = true;
        },
        
        saveUserLimits() {
            const limits = {
                is_admin: this.currentUser.is_admin === true || this.currentUser.is_admin === 'true',
                rate_limit: parseInt(this.currentUser.rate_limit),
                max_scripts: this.userLimits.max_scripts ? parseInt(this.userLimits.max_scripts) : null,
                max_script_size: this.userLimits.max_script_size ? parseInt(this.userLimits.max_script_size) : null
            };
            
            fetch(`/api/admin/users/${this.currentUser.id}/limits`, {
                method: 'PUT',
                headers: {
                    'Authorization': 'Bearer ' + getToken(),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(limits)
            })
            .then(() => {
                this.showToastMessage('User settings updated successfully');
                this.showUserModal = false;
                this.loadUsers();
            })
            .catch(() => {
                this.showToastMessage('Failed to update settings');
            });
        },
        
        resetPassword(user) {
            this.resetUser = user;
            this.newPassword = '';
            this.showResetModal = true;
        },
        
        confirmResetPassword() {
            // Generate random password
            const password = this.generatePassword();
            
            fetch(`/api/admin/users/${this.resetUser.id}/password`, {
                method: 'PUT',
                headers: {
                    'Authorization': 'Bearer ' + getToken(),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ new_password: password })
            })
            .then(() => {
                this.newPassword = password;
                this.showToastMessage('Password reset successfully');
            })
            .catch(() => {
                this.showToastMessage('Failed to reset password');
            });
        },
        
        deleteUser(user) {
            if (!confirm(`Delete user "${user.username}" and all their scripts? This cannot be undone.`)) {
                return;
            }
            
            fetch(`/api/admin/users/${user.id}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + getToken() }
            })
            .then(() => {
                this.showToastMessage('User deleted successfully');
                this.loadUsers();
            })
            .catch(() => {
                this.showToastMessage('Failed to delete user');
            });
        },
        
        generatePassword() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789!@#$%^&*';
            let password = '';
            for (let i = 0; i < 16; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        },
        
        showToastMessage(message) {
            this.toastMessage = message;
            this.showToast = true;
            setTimeout(() => {
                this.showToast = false;
            }, 3000);
        }
    }
}
</script>
{{end}}
