{{define "content"}}
<div x-data="dashboard()" x-init="init()">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold">My Scripts</h1>
        <a href="/script-editor" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">New Script</a>
    </div>

    <!-- Filters and Search -->
    <div class="bg-white p-4 rounded-lg shadow mb-6">
        <div class="flex flex-wrap gap-4 items-center">
            <div class="flex-1 min-w-[200px]">
                <input type="text" x-model="searchQuery" 
                       placeholder="Search scripts by name or description..."
                       class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500">
            </div>
            <div class="flex gap-2">
                <button @click="visibilityFilter = 'all'" 
                        :class="visibilityFilter === 'all' ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-700'"
                        class="px-4 py-2 rounded hover:opacity-80">
                    All
                </button>
                <button @click="visibilityFilter = 'public'" 
                        :class="visibilityFilter === 'public' ? 'bg-green-600 text-white' : 'bg-gray-200 text-gray-700'"
                        class="px-4 py-2 rounded hover:opacity-80">
                    Public
                </button>
                <button @click="visibilityFilter = 'unlisted'" 
                        :class="visibilityFilter === 'unlisted' ? 'bg-yellow-600 text-white' : 'bg-gray-200 text-gray-700'"
                        class="px-4 py-2 rounded hover:opacity-80">
                    Unlisted
                </button>
                <button @click="visibilityFilter = 'private'" 
                        :class="visibilityFilter === 'private' ? 'bg-red-600 text-white' : 'bg-gray-200 text-gray-700'"
                        class="px-4 py-2 rounded hover:opacity-80">
                    Private
                </button>
            </div>
            <div class="flex items-center gap-2">
                <label class="flex items-center space-x-2 text-sm">
                    <input type="checkbox" x-model="showShared" @change="loadScripts()" class="form-checkbox">
                    <span>Show Shared</span>
                </label>
            </div>
        </div>
        <div class="mt-2 text-sm text-gray-600" x-text="`Showing ${filteredScripts.length} of ${scripts.length} scripts`"></div>
    </div>

    <!-- Toast notification -->
    <div x-show="showToast" x-transition 
         class="fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50"
         style="display: none;">
        <span x-text="toastMessage"></span>
    </div>

    <div x-show="scripts.length === 0" class="text-center py-12 bg-white rounded-lg shadow">
        <p class="text-gray-600 mb-4">You haven't created any scripts yet.</p>
        <a href="/script-editor" class="text-indigo-600 hover:text-indigo-700">Create your first script</a>
    </div>

    <div x-show="scripts.length > 0 && filteredScripts.length === 0" class="text-center py-12 bg-white rounded-lg shadow">
        <p class="text-gray-600">No scripts match your filters.</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <template x-for="script in filteredScripts" :key="script.id">
            <div class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h3 class="text-xl font-bold" x-text="script.name"></h3>
                        <p x-show="script.shared" class="text-xs text-gray-500">by <span x-text="script.owner"></span></p>
                    </div>
                    <span class="text-xs px-2 py-1 rounded" 
                          :class="{
                              'bg-green-100 text-green-800': script.visibility === 'public',
                              'bg-yellow-100 text-yellow-800': script.visibility === 'unlisted',
                              'bg-red-100 text-red-800': script.visibility === 'private'
                          }"
                          x-text="script.visibility"></span>
                </div>
                <p class="text-gray-600 mb-2 text-sm" x-text="script.description || 'No description'"></p>
                <div class="flex items-center space-x-2 text-sm text-gray-500 mb-4">
                    <span x-text="'v' + script.version"></span>
                    <span>•</span>
                    <span x-text="new Date(script.updated_at).toLocaleDateString()"></span>
                </div>
                <div class="flex flex-wrap gap-2">
                    <a x-show="!script.shared" :href="'/script-editor?id=' + script.id" class="text-indigo-600 hover:text-indigo-700 text-sm">Edit</a>
                    <button @click="viewScript(script)" class="text-blue-600 hover:text-blue-700 text-sm">View</button>
                    <button @click="copyUrl(script)" class="text-green-600 hover:text-green-700 text-sm">Copy URL</button>
                    <button x-show="!script.shared && script.visibility === 'unlisted'" @click="shareScript(script)" class="text-purple-600 hover:text-purple-700 text-sm">Share</button>
                    <button x-show="!script.shared" @click="deleteScript(script.id)" class="text-red-600 hover:text-red-700 text-sm">Delete</button>
                </div>
            </div>
        </template>
    </div>

    <!-- View Modal -->
    <div x-show="viewModal" @click.away="viewModal = false" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white p-8 rounded-lg max-w-4xl w-full max-h-screen overflow-y-auto" @click.stop>
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 class="text-2xl font-bold" x-text="currentScript?.name"></h2>
                    <p class="text-gray-600" x-text="currentScript?.description"></p>
                </div>
                <button @click="viewModal = false" class="text-gray-500 hover:text-gray-700">✕</button>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Usage:</label>
                <div class="bg-gray-900 text-green-400 p-4 rounded font-mono text-sm space-y-2">
                    <div x-show="!currentScript?.shared">
                        <div class="text-gray-500 mb-1"># Your script</div>
                        <div>shebang get <span x-text="currentScript?.name"></span></div>
                        <div>shebang run <span x-text="currentScript?.name"></span></div>
                    </div>
                    <div x-show="currentScript?.shared">
                        <div class="text-gray-500 mb-1"># Shared script</div>
                        <div>shebang get <span x-text="currentScript?.name"></span> -u <span x-text="currentScript?.owner"></span></div>
                        <div>shebang run <span x-text="currentScript?.name"></span> -u <span x-text="currentScript?.owner"></span></div>
                    </div>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Content:</label>
                <pre class="bg-gray-100 p-4 rounded overflow-x-auto text-sm" x-text="scriptContent"></pre>
            </div>
        </div>
    </div>
    
    <!-- Share Modal -->
    <div x-show="shareModal" @click.away="shareModal = false" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white p-8 rounded-lg max-w-2xl w-full" @click.stop>
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-2xl font-bold">Share Script: <span x-text="currentScript?.name"></span></h2>
                <button @click="shareModal = false" class="text-gray-500 hover:text-gray-700">✕</button>
            </div>
            
            <div class="mb-6">
                <label class="flex items-center space-x-2 mb-4">
                    <input type="radio" x-model="shareType" value="link" class="form-radio">
                    <span>Anyone with link</span>
                </label>
                <label class="flex items-center space-x-2">
                    <input type="radio" x-model="shareType" value="user" class="form-radio">
                    <span>Specific users</span>
                </label>
            </div>
            
            <div x-show="shareType === 'user'" class="mb-4">
                <label class="block text-sm font-medium mb-2">Search users</label>
                <input type="text" 
                       x-model="userSearch" 
                       @input.debounce.300ms="searchUsers"
                       placeholder="Type username..."
                       class="w-full px-3 py-2 border rounded">
                
                <div x-show="userSearchResults.length > 0" class="mt-2 border rounded max-h-40 overflow-y-auto">
                    <template x-for="username in userSearchResults" :key="username">
                        <div @click="addUser(username)" class="px-3 py-2 hover:bg-gray-100 cursor-pointer" x-text="username"></div>
                    </template>
                </div>
                
                <div class="mt-4">
                    <label class="block text-sm font-medium mb-2">Selected users:</label>
                    <div class="space-y-2">
                        <template x-for="username in selectedUsers" :key="username">
                            <div class="flex justify-between items-center bg-gray-100 px-3 py-2 rounded">
                                <span x-text="username"></span>
                                <button @click="removeUser(username)" class="text-red-600 hover:text-red-800">✕</button>
                            </div>
                        </template>
                        <div x-show="selectedUsers.length === 0" class="text-sm text-gray-500">No users selected</div>
                    </div>
                </div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Current access:</label>
                <div class="space-y-2 max-h-40 overflow-y-auto">
                    <template x-for="access in currentAccess" :key="access.id">
                        <div class="flex justify-between items-center bg-blue-50 px-3 py-2 rounded text-sm">
                            <span x-text="access.access_type === 'link' ? 'Anyone with link' : access.username"></span>
                            <button @click="removeAccess(access.id)" class="text-red-600 hover:text-red-800">Remove</button>
                        </div>
                    </template>
                    <div x-show="!currentAccess || currentAccess.length === 0" class="text-sm text-gray-500">Not shared</div>
                </div>
            </div>
            
            <div class="flex justify-end space-x-2">
                <button @click="shareModal = false" class="px-4 py-2 border rounded hover:bg-gray-50">Cancel</button>
                <button @click="saveShare()" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Save</button>
            </div>
        </div>
    </div>
</div>

<script>
function dashboard() {
    return {
        scripts: [],
        searchQuery: '',
        visibilityFilter: 'all',
        showShared: true,
        viewModal: false,
        shareModal: false,
        currentScript: null,
        scriptContent: '',
        showToast: false,
        toastMessage: '',
        shareType: 'link',
        userSearch: '',
        userSearchResults: [],
        selectedUsers: [],
        currentAccess: [],
        
        get filteredScripts() {
            let filtered = this.scripts;
            
            // Filter by visibility
            if (this.visibilityFilter !== 'all') {
                filtered = filtered.filter(s => s.visibility === this.visibilityFilter);
            }
            
            // Search by name, description, or content (for non-private)
            if (this.searchQuery) {
                const query = this.searchQuery.toLowerCase();
                filtered = filtered.filter(s => {
                    // Always search name and description
                    if (s.name.toLowerCase().includes(query) || 
                        (s.description && s.description.toLowerCase().includes(query))) {
                        return true;
                    }
                    
                    // For non-private scripts, also search content
                    if (s.visibility !== 'private' && s.cachedContent) {
                        return s.cachedContent.toLowerCase().includes(query);
                    }
                    
                    return false;
                });
            }
            
            return filtered;
        },
        
        init() {
            if (!getToken()) {
                window.location.href = '/login';
                return;
            }
            this.loadScripts();
        },
        
        getUser() {
            return JSON.parse(localStorage.getItem('user') || '{}');
        },
        
        async loadScripts() {
            // Load user's own scripts
            const response = await fetch('/api/scripts', {
                headers: { 'Authorization': 'Bearer ' + getToken() }
            });
            let myScripts = [];
            if (response.ok) {
                myScripts = await response.json() || [];
            }
            
            // Load shared scripts if enabled
            let sharedScripts = [];
            if (this.showShared) {
                const sharedResponse = await fetch('/api/shared/scripts', {
                    headers: { 'Authorization': 'Bearer ' + getToken() }
                });
                if (sharedResponse.ok) {
                    sharedScripts = await sharedResponse.json() || [];
                }
            }
            
            this.scripts = [...myScripts, ...sharedScripts];
            
            // Fetch content for non-private scripts for search
            this.scripts.forEach(script => {
                if (script.visibility !== 'private') {
                    const owner = script.owner || this.getUser().username;
                    fetch(`/${owner}/${script.name}`, {
                        headers: { 'Authorization': 'Bearer ' + getToken() }
                    })
                        .then(res => res.text())
                        .then(content => {
                            script.cachedContent = content;
                        })
                        .catch(() => {});
                }
            });
        },
        
        viewScript(script) {
            this.currentScript = script;
            const owner = script.owner || this.getUser().username;
            fetch(`/${owner}/${script.name}`, {
                headers: { 'Authorization': 'Bearer ' + getToken() }
            })
                .then(res => res.text())
                .then(content => {
                    this.scriptContent = content;
                    this.viewModal = true;
                })
                .catch(err => {
                    this.showToastMessage('Failed to load script');
                });
        },
        
        copyUrl(script) {
            const owner = script.owner || this.getUser().username;
            const url = `${window.location.origin}/${owner}/${script.name}`;
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(url).then(() => {
                    this.showToastMessage('URL copied to clipboard!');
                }).catch(() => {
                    this.fallbackCopy(url);
                });
            } else {
                this.fallbackCopy(url);
            }
        },
        
        fallbackCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                this.showToastMessage('URL copied to clipboard!');
            } catch (err) {
                this.showToastMessage('Failed to copy URL');
            }
            document.body.removeChild(textarea);
        },
        
        showToastMessage(message) {
            this.toastMessage = message;
            this.showToast = true;
            setTimeout(() => {
                this.showToast = false;
            }, 3000);
        },
        
        deleteScript(id) {
            if (!confirm('Delete this script? This cannot be undone.')) return;
            
            fetch('/api/scripts/' + id, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + getToken() }
            })
            .then(() => this.loadScripts());
        },
        
        async shareScript(script) {
            this.currentScript = script;
            this.shareType = 'link';
            this.selectedUsers = [];
            this.userSearch = '';
            this.userSearchResults = [];
            
            // Load current access
            const response = await fetch(`/api/scripts/${script.id}/access`, {
                headers: { 'Authorization': 'Bearer ' + getToken() }
            });
            if (response.ok) {
                this.currentAccess = await response.json();
            }
            
            this.shareModal = true;
        },
        
        async searchUsers() {
            if (!this.userSearch || this.userSearch.length < 2) {
                this.userSearchResults = [];
                return;
            }
            
            const response = await fetch(`/api/users/search?q=${encodeURIComponent(this.userSearch)}`, {
                headers: { 'Authorization': 'Bearer ' + getToken() }
            });
            if (response.ok) {
                this.userSearchResults = await response.json();
            }
        },
        
        addUser(username) {
            if (!this.selectedUsers.includes(username)) {
                this.selectedUsers.push(username);
            }
            this.userSearch = '';
            this.userSearchResults = [];
        },
        
        removeUser(username) {
            this.selectedUsers = this.selectedUsers.filter(u => u !== username);
        },
        
        async saveShare() {
            const payload = {
                access_type: this.shareType,
                usernames: this.shareType === 'user' ? this.selectedUsers : []
            };
            
            const response = await fetch(`/api/scripts/${this.currentScript.id}/access`, {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + getToken(),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });
            
            if (response.ok) {
                this.shareModal = false;
                this.showToastMessage('Sharing updated');
            }
        },
        
        async removeAccess(accessId) {
            const response = await fetch(`/api/scripts/${this.currentScript.id}/access/${accessId}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + getToken() }
            });
            
            if (response.ok) {
                this.currentAccess = this.currentAccess.filter(a => a.id !== accessId);
                this.showToastMessage('Access removed');
            }
        }
    }
}
</script>
{{end}}
